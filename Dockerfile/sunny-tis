# Build enviroments
FROM zhuoqiw/ros-opencv:4.5.2 AS OPENCV

FROM zhuoqiw/ros-tis:0.14.0

# Install dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
  nano \
  libgpiod-dev \
  libmodbus-dev \
  && rm -rf /var/lib/apt/lists/*

# Install OpenCV
COPY --from=OPENCV /opt/OpenCV /opt/OpenCV

# Update ldconfig
RUN echo "/opt/OpenCV/lib" > /etc/ld.so.conf.d/OpenCV.conf \
  && ldconfig

# Copy source codes
COPY ./ros_entrypoint.sh /ws/ros_entrypoint.sh
COPY ./src /ws/src

# Use /ws as working directory
WORKDIR /ws

# colcon build
RUN /ros_entrypoint.sh colcon build \
  --cmake-args \
    -DCMAKE_BUILD_TYPE=Release \
  --packages-select \
    shared_interfaces \
    ros2_numpy \
    camera_tis \
    rotate_image \
    branch_image \
    laser_line_center \
    line_center_reconstruction \
    modbus \
    seam_tracking \
    gpio_raspberry \
    pipeline_tis

# colcon test
# RUN /ros_entrypoint.sh colcon test \
#   --packages-select \
#     shared_interfaces \
#     camera_tis \
#     rotate_image \
#     branch_image \
#     laser_line_center \
#     line_center_reconstruction \
#     modbus \
#     seam_tracking \
#     gpio_raspberry \
#     pipeline_tis

RUN chmod +x /ws/ros_entrypoint.sh

